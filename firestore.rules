
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      allow read;
      allow write: if request.auth.uid == userId;
    }

    match /ads/{adId} {
      allow read;
      allow create: if request.auth != null;

      function isOwner() {
        return request.auth.uid == resource.data.userId;
      }

      function isLiking() {
        // Checks if the user is only updating the 'likes' and 'likedBy' fields.
        let changedKeys = request.resource.data.diff(resource.data).affectedKeys;
        return changedKeys.hasOnly(['likes', 'likedBy']);
      }

      function isEditingAd() {
        // Checks if the user is not touching the 'likes' and 'likedBy' fields.
        let changedKeys = request.resource.data.diff(resource.data).affectedKeys;
        return !changedKeys.hasAny(['likes', 'likedBy']);
      }

      // 1. Owner can edit their ad, but cannot touch the like fields in the same update.
      // 2. Any authenticated user can like/unlike an ad (updating only like fields).
      allow update: if (isOwner() && isEditingAd()) || (request.auth != null && isLiking());

      allow delete: if isOwner();
    }
  }
}
